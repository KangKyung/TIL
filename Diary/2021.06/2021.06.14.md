# Understanding Swift Performance

### Value Semantics

: value typeì„ ì´ìš©í•œ ë§¤ì»¤ë‹ˆì¦˜. Copy-by-Value.

- ìŠ¤ìœ„í”„íŠ¸ì—ì„œëŠ” Objective-Cì— ì—†ë˜ ìƒˆë¡œìš´ Value Typeì¸ `struct`, `enum`, `tuple`ë„ì…
- ë³€ìˆ˜ í• ë‹¹ ì‹œ Stackì— ê°’ ì „ì²´ê°€ ì €ì¥ë¨
- copy by value - ë³€ìˆ˜ë“¤ì´ ë¶„ë¦¬ë¨(í•˜ë‚˜ë¥¼ ë³€ê²½í•´ë„ ë‹¤ë¥¸ ê²ƒì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŒ)
- Heapì„ ì‚¬ìš©í•˜ëŠ”ê²Œ ì•„ë‹ˆê¸° ë•Œë¬¸ì—, Reference Countingì„ í•  í•„ìš”ê°€ ì—†ìŒ
- ê° ë³€ìˆ˜ëŠ” ê°’(value)ì— ì˜í•´ êµ¬ë¶„ì´ ë˜ì–´ì•¼í•œë‹¤ â†’ ë™ì¹˜ê´€ê³„ë¥¼ ë§Œì¡±í•´ì•¼ í•œë‹¤. â†’ Equatable í”„ë¡œí† ì½œ êµ¬í˜„
- Threadë¥¼ ë‹¤ë£¨ëŠ” ê³¼ì •ì—ì„œ, Threadê°„ì˜ ì˜ë„í•˜ì§€ì•Šì€ ê³µìœ ë¡œë¶€í„° ì•ˆì í•¨

### ì„±ëŠ¥ì„ ìœ„í•´ ê³ ë ¤í•  ê²ƒë“¤

- ë©”ëª¨ë¦¬ í• ë‹¹: Stackì— í• ë‹¹í• ì§€ Heapì— í• ë‹¹í• ì§€

  - Heapí• ë‹¹ì‹œ ë¹ˆ ê³³ì„ ì°¾ê³  ê´€ë¦¬í•˜ëŠ” ê²ƒì€ ë³µì¡í•œ ê³¼ì •
  - ê·¸ ê³¼ì •ì´ Thread safeí•´ì•¼ í•¨ â†’ ë‹¤ë¥¸ Threadë¼ë¦¬ì˜ ì¶©ëŒì„ ë§‰ê¸°ìœ„í•´, `lock`ë“±ì˜ synchronization ë™ì‘ì„ì§„í–‰ â†’ ì´ëŠ” ì„±ëŠ¥ì €í•˜ë¥¼ í¬ê²Œ ì¼ìœ¼í‚¬ ìˆ˜ ìˆëŠ” ìš”ì†Œê°€ ë¨
  - ë°˜ë©´ Stack í• ë‹¹ì€ ë‹¨ìˆœíˆ ìŠ¤íƒí¬ì¸í„° ë³€ìˆ˜ê°’ë§Œ ë°”ê¿”ì£¼ëŠ” ì •ë„

- Reference Countingì´ ì¡´ì¬í•˜ëŠ”ê°€

  - ìƒê°ë³´ë‹¤ ë§¤ìš° ìì£¼ ì‹¤í–‰ëœë‹¤. ex> ë³€ìˆ˜ copyë¥¼ í•  ë•Œ ë§ˆë‹¤
  - Thread safetyí•˜ê²Œ ì§„í–‰í•´ì•¼í•¨: ì¹´ìš´íŠ¸ ì§„í–‰ì‹œ Atomicí•˜ê²Œ ëŠ˜ë¦¬ê³  ì¤„ì´ëŠ” ë™ì‘ì„ í•˜ê²Œ ë˜ê¸° ë•Œë¬¸ â†’ ARC(Automatic Reference Counting): retain, releaseì‘ì—…ì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•¨ â†’ ì´ëŠ” ì„±ëŠ¥ì €í•˜ë¥¼ í¬ê²Œ ì¼ìœ¼í‚¬ ìˆ˜ ìˆëŠ” ìš”ì†Œê°€ ë¨

- ë©”ì„œë“œ í˜¸ì¶œì‹œ staticí•˜ê²Œ í•˜ëŠ”ê°€ Dynamicí•˜ê²Œ í•˜ëŠ”ê°€ (Method Dispatch)

  - Dispatch: ë©”ì„œë“œë¥¼ ì°¾ì•„ í˜¸ì¶œí•˜ëŠ” ë°©ì‹

  - ì»´íŒŒì¼ ì‹œì ì—ì„œ ë©”ì†Œë“œì˜ ì‹¤ì œ ì½”ë“œìœ„ì¹˜ë¥¼ ë¯¸ë¦¬ ì•Œê³ ìˆìœ¼ë©´, ì‹¤í–‰ì¤‘ ì°¾ëŠ” ê³¼ì •ì—†ì´ ë°”ë¡œ í•´ë‹¹ ì½”ë“œë¡œì˜ ì ‘ê·¼ì´ ê°€ëŠ¥í•¨!! â†’ ë©”ì†Œë“œ ì¸ë¼ì´ë‹(Inlining)ë“±ì˜ ì»´íŒŒì¼ëŸ¬ ìµœì í™”ê°€ ê°€ëŠ¥

    ```swift
    // ë©”ì†Œë“œ ì¸ë¼ì´ë‹ ì´ë€,
    // ì»´íŒŒì¼ ì‹œì ì—ì„œ ë©”ì†Œë“œ í˜¸ì¶œ ë¶€ë¶„ì— ë©”ì†Œë“œì˜ ë‚´ìš©ì„ ë¶™ì—¬ë„£ëŠ” ê³¼ì •
    // (ë‹¨, íš¨ê³¼ê°€ ìˆë‹¤ê³  íŒë‹¨ë˜ëŠ” ê²½ìš°ì—ë§Œ)
    struct Point {
    	var x, y: CGFloat
    	func draw() {
    		// Point.draw implementation
    	}
    }
    
    func drawAPoint(param: Point) {
    		param.draw()
    }
    
    let point = Point(x: 0, y: 0)
    drawAPoint(point)
    ```

    ì—¬ê¸°ì„œ `drawAPoint(point)`ëŠ” ê²°êµ­ `point.draw()`ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê²ƒì´ë©°, ì´ëŠ” ê²°êµ­ `// Point.draw implementation`ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê²ƒì´ì£ ? ì´ë ‡ê²Œ ê°ê°ì˜ ê²½ìš°ì— ì¸ë¼ì´ë‹ì´ ì¼ì–´ë‚¬ë‹¤ê³  ë³´ë©´ ë¼ìš”! ì—¬ê¸°ì„œëŠ” ì¸ë¼ì´ë‹ì´ ë‘ ë²ˆ ì¼ì–´ë‚¬ìœ¼ë¯€ë¡œ, 2ë‹¨ê³„ì˜ í˜¸ì¶œì´ ì¤„ì–´ ì¶”ê°€ì ì¸ ìµœì í™”ì˜ ê¸°íšŒê°€ ìƒê¸´ ê²ƒì´ì£ !

  - Reference Semanticsì—ì„œì˜ ë‹¤í˜•ì„±(Polymorphism)

    ```swift
    class Drawable { func draw() {} }
    
    class Point: Drawable {
    	var x, y: CGFloat
    	override func draw() { ... }
    }
    
    class Line: Drawable {
    	var x1, y1, x2, y2: CGFloat
    	override func draw() { ... }
    }
    
    func draw(drawable: Drawable, withColor color: UIColor) {
    	color.setFill()
    	drawable.draw()
    }
    ```

    ì—¬ê¸°ì„œëŠ” ì»´íŒŒì¼ëŸ¬ ì…ì¥ì—ì„œ ë³¼ ë•Œ, `drawable.draw()`ë¶€ë¶„ì˜ `drawable`ì´ ë‚˜íƒ€ë‚´ëŠ” ê²ƒì´ `Point`ì¸ì§€, `Line`ì¸ì§€ë¥¼ ëª¨ë¦…ë‹ˆë‹¤...! ì´ëŠ” ëŸ°íƒ€ì„ ë‹¨ê³„ì¼ ë•Œë§Œ ì•Œ ìˆ˜ ìˆëŠ” ê²ƒì´ì£ ! ì—¬ê¸°ì„œëŠ” Thread safetyì™€ ê°™ì€ í° ë¬¸ì œê°€ ì¼ì–´ë‚˜ëŠ” ê²ƒì€ ì•„ë‹ˆì§€ë§Œ, ì´ë¡œì¸í•´ ì»´íŒŒì¼ëŸ¬ê°€ ìµœì í™”ë¥¼ í•˜ì§€ ëª»í•˜ëŠ” ê²ƒì´ í° ë¬¸ì œë¼ê³  ë³¼ ìˆ˜ ìˆì£ ! (ì†ë„ì €í•˜)

  - Static Dispatchë¡œ ê°•ì œí•˜ê¸°

    - `final`, `private`ì„ ì“°ëŠ” ìŠµê´€ì„ ë“¤ì…ì‹œë‹¤!
    - `dynamic`í‚¤ì›Œë“œë¥¼ (ì™ ë§Œí•˜ë©´)ì“°ì§€ ë§™ì‹œë‹¤!
    - Objc ì—°ë™ì„ ìµœì†Œí™” í•©ì‹œë‹¤(Objective-Cì˜ Runtimeì„ í†µí•˜ê²Œ ë¨)
    - ì»´íŒŒì¼ ë¹Œë“œì˜µì…˜ ì¤‘ WMO(whole module optimization)ì„ í‚¤ì! (ì• í”Œì˜ ê¶Œì¥) â†’ ë¹Œë“œì‹œ í•œë²ˆì— ëª¨ë“  íŒŒì¼ë“¤ì„ ë¶„ì„í•˜ì—¬, static dispatchë¡œ ë³€í™˜ì´ ê°€ëŠ¥í•œì§€ ë“±ì„ íŒë‹¨í•˜ì—¬ ìµœì í™”ë¥¼ ì§„í–‰í•¨ (ê·¼ë°, ì—„ì²­ë‚˜ê²Œ ëŠë ¤ì§„ë‹¤ê³  í•©ë‹ˆë‹¤.. ì•„ì§ ì•ˆì •í™”ë„ ë˜ì§€ ì•Šì•˜ë‹¤ê³  í•˜ê³ ìš”! - 2017ê¸°ì¤€)

### ìŠ¤ìœ„í”„íŠ¸ì˜ ì¶”ìƒí™” ê¸°ë²•ë“¤ì˜ ì„±ëŠ¥

- Class: Identityê°€ í•„ìš”í•œ ê²½ìš°, ìƒì† ë“±ì˜ OOP, Objective-C

  - ë©”ëª¨ë¦¬ í• ë‹¹: Heap, Reference Counting ì‚¬ìš©O, Method Dispatch: Dynamic
  - ì„±ëŠ¥ì— ìƒê´€ì—†ì´ ë ˆí¼ëŸ°ìŠ¤ sementicsê°€ í•„ìš”í•  ë•Œ ì¨ì•¼í•¨: Identity, ìƒì† ë“± (ë‹¨, ë ˆí¼ëŸ°ìŠ¤ì˜ ì˜ë„í•˜ì§€ì•Šì€ ê³µìœ ë¡œì¸í•œ ë¬¸ì œëŠ” ì¡°ì‹¬)
  - final classë¥¼ ì‚¬ìš©í•˜ë©´ ê·¸ë‚˜ë§ˆ Method Dispatch: Staticì´ ë¨

- Struct: ì—”í„°í‹° ë“± Value Sementicì´ ë§ëŠ” ê²½ìš°

  - Structì•ˆì— value typeì˜ ê°’ë“¤ë§Œ ì˜¬ ê²½ìš° â†’ ë©”ëª¨ë¦¬ í• ë‹¹: Stack, Reference Counting ì‚¬ìš©X, Method Dispatch: Static

  - Structì•ˆì— reference typeì˜ ê°’ì´ ë“¤ì–´ê°ˆ ê²½ìš° â†’ ë©”ëª¨ë¦¬ í• ë‹¹: Stack, Reference Counting ì‚¬ìš©O(ë§ì„ ìˆ˜ ìˆë‹¤), Method Dispatch: Static â†’ Reference Countingì„ ì¤„ì´ê¸° ìœ„í•´, ê°’ì˜ ì œí•œì´ ê°€ëŠ¥í•˜ë©´ enumë“±ì˜ value typeìœ¼ë¡œ ë³€ê²½í•˜ê³ , ë‹¤ìˆ˜ì˜ classë“¤ì„ í•˜ë‚˜ì˜ classë¡œ ëª°ì•„ë„£ëŠ” ê²ƒì´ ì¢‹ë‹¤.

    ```swift
    // 9ê°œì˜ ì°¸ì¡°íƒ€ì…ì„ ê°€ì§€ëŠ” ê²½ìš°
    // -> Copyí•  ë•Œë§ˆë‹¤ 9ë²ˆì˜ Reference Countingì´ ì¼ì–´ë‚œë‹¤
    
    struct HTTPRequest {
    	var protocol: String         // (1)
    	var domain: String           // (2)
    	var path: String             // (3)
    	var filename: String         // (4)
    	var extension: String        // (5)
    	var query: [String: String]  // (6)
    	var httpMethod: String       // (7)
    	var httpVersion: Stirng      // (8)
    	var httpHost: String         // (9)
    }
    ```

    ```swift
    // ìœ„ì˜ Reference Countingì„ 2ê°œë¡œ ì¤„ì´ëŠ” ê²½ìš°!
    
    // ì •í•´ì§„ ê°’ì´ ìˆëŠ” ê²ƒë“¤ì€ enumìœ¼ë¡œ ë¬¶ëŠ”ë‹¤!!
    enum HttpMethod {
    	case Get, Post, Put, Delete
    }
    
    enum HTTPVersion {
    	case _1_0, _1_1
    }
    
    struct HTTPRequest {
    	var url: NSURL                // (1)
    	var httpMethod: HTTPMethod
    	var httpVersion: HTTPVersion
    	var httpHost: String          // (2)
    }
    ```

- Protocol Type: ë™ì  ë‹¤í˜•ì„±ì´ í•„ìš”í•œ ê²½ìš°

  - ì½”ë“œ ì—†ì´ APIë§Œ ì •ì˜í•¨ â†’ ìƒì† ì—†ëŠ” ë‹¤í˜•ì„±(Polymorphism) êµ¬í˜„ì´ ê°€ëŠ¥
  - value typeì¸ structì—ë„ ì ìš©ì´ ê°€ëŠ¥í•¨â­ï¸
  - Copyë™ì‘ â†’ 3word ì´í•˜: Existential containerì— ì „ì²´ ê°’ë“¤ì´ ë³µì‚¬ë¨ ë©”ëª¨ë¦¬ í• ë‹¹: Stack, Reference Counting ì‚¬ìš©X, Method Dispatch: Dynamic (Protocol Witness Table) â†’ 3word ì´ˆê³¼: Heapì— í• ë‹¹ëœ í›„, í•´ë‹¹ referenceê°€ Existential containerì— ì €ì¥ë¨ ë©”ëª¨ë¦¬ í• ë‹¹: Many, Reference Counting ì‚¬ìš©X, Method Dispatch: Dynamic (Protocol Witness Table) â‡’ ì„±ëŠ¥ ì €í•˜ë¥¼ ë§‰ê¸°ìœ„í•´ Indirect Storage, Copy-on-Writeë“±ì„ ì´ìš©...ğŸ¤¯ ë©”ëª¨ë¦¬ í• ë‹¹: Heap, Reference Counting ì‚¬ìš©O, Method Dispatch: Dynamic (Protocol Witness Table)
  - Protocol Typeì„ ì“¸ ë•Œ ëŒ€ìƒì´ í° structë©´ â†’ Indirect storageë¡œ struct êµ¬ì¡°ë¥¼ ë³€ê²½í•˜ì! â†’ Mutableí•´ì•¼í•˜ë©´ Copy-on-Write(ìˆ˜ì •í•˜ë ¤ê³  í•  ë•Œë§Œ ì‹¤ì§ˆì ìœ¼ë¡œ ë³µì‚¬í•¨)ë¥¼ êµ¬í˜„í•˜ì!

- Generics Type: ì •ì  ë‹¤í˜•ì„±ìœ¼ë¡œ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•œ ê²½ìš°

  - Method ë‚´ì˜ `T`ëŠ” ë°”ë€Œì§€ ì•ŠëŠ”ë‹¤ â†’ ì •ì  ë‹¤í˜•ì„±(Static Polymorphism)
  - ì»´íŒŒì¼ëŸ¬ê°€ ì•Œì•„ì„œ ìµœì í™”ë¥¼ ì§„í–‰í•¨: Genericì˜ íŠ¹ìˆ˜í™” (Specialization)
  - íŠ¹ìˆ˜í™” ë˜ì§€ì•Šì€ Generics (ì‘ì€ ì‚¬ì´ì¦ˆì˜ Protocol Typeì¸ ê²½ìš°) â†’ ë©”ëª¨ë¦¬ í• ë‹¹: Stack, Reference Counting ì‚¬ìš©X, Method Dispatch: Dynamic (Protocol Witness Table)
  - íŠ¹ìˆ˜í™” ëœ Generics Type (struct) â†’ ë©”ëª¨ë¦¬ í• ë‹¹: Stack, Reference Counting ì‚¬ìš©X, Method Dispatch: Static
  - íŠ¹ìˆ˜í™” ë˜ì§€ì•Šì€ Generics (í° ì‚¬ì´ì¦ˆì˜ Protocol Typeì¸ ê²½ìš°) â†’ ë©”ëª¨ë¦¬ í• ë‹¹: Many(copyí•  ë•Œ ë§ˆë‹¤ í• ë‹¹), Reference Counting ì‚¬ìš©X, Method Dispatch: Dynamic (Protocol Witness Table)
  - íŠ¹ìˆ˜í™” ëœ Generics Type (class) â†’ ë©”ëª¨ë¦¬ í• ë‹¹: Heap, Reference Counting ì‚¬ìš©O, Method Dispatch: Dynamic (V-Table)

### ìŠ¤ìœ„í”„íŠ¸ì˜ ì„±ëŠ¥

- Objective-Cì— ë¹„í•´ í° í–¥ìƒì´ ìˆì—ˆìœ¼ë‚˜, Valueíƒ€ì…ê³¼ Protocol íƒ€ì…ë“¤ì˜ ì„±ê²©ì„ ê³ ë ¤í•´ì•¼í•¨
- ì„±ëŠ¥ ìµœì í™”ë¥¼ ê³ ë ¤í•´ì•¼í•˜ëŠ” ê²½ìš°ì˜ ì˜ˆ
  - ë Œë”ë§ ê´€ë ¨ ë¡œì§ ë“± ë°˜ë³µì ìœ¼ë¡œ ë§¤ìš° ë¹ˆë²ˆíˆ ë¶ˆë¦¬ëŠ” ê²½ìš°
  - ì„œë²„ í™˜ê²½ì—ì„œì˜ ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬

### Reference

[ìŠ¤ìœ„í”„íŠ¸ ì„±ëŠ¥ ì´í•´í•˜ê¸° - ìœ ìš©í•˜](https://www.youtube.com/watch?v=z1Gf6EosaUQ)

# í”„ë¡œì íŠ¸

step2 ì§„í–‰